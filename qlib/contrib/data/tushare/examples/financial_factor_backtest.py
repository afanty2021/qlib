#!/usr/bin/env python3
"""
è´¢åŠ¡å› å­å›æµ‹ç¤ºä¾‹

æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ä¸‹è½½çš„è´¢åŠ¡æ•°æ®ï¼ˆ2023-2024ï¼‰è¿›è¡Œå›æµ‹
"""

import pandas as pd
import numpy as np
from pathlib import Path
from datetime import datetime

def explain_financial_data_backtest():
    """è§£é‡Šè´¢åŠ¡æ•°æ®å›æµ‹åŸç†"""

    print("\nğŸ“Š è´¢åŠ¡æ•°æ®å›æµ‹åŸç†")
    print("="*80)

    print("\n1ï¸âƒ£ è´¢åŠ¡æ•°æ®çš„ä½œç”¨:")
    print("   â€¢ è´¢åŠ¡æ•°æ® = ç”¨æ¥è¯„ä¼°å…¬å¸è´¨é‡çš„ä½é¢‘æ•°æ®")
    print("   â€¢ ä»·æ ¼æ•°æ® = ç”¨æ¥äº¤æ˜“çš„é«˜é¢‘æ•°æ®")
    print("   â€¢ å›æµ‹ = ç”¨è´¢åŠ¡å› å­é€‰è‚¡ï¼Œç”¨ä»·æ ¼æ•°æ®äº¤æ˜“")

    print("\n2ï¸âƒ£ ä½¿ç”¨2023-2024è´¢åŠ¡æ•°æ®å›æµ‹çš„æ–¹æ¡ˆ:")
    print("   âœ… æ–¹æ¡ˆA: 2024å¹´å…¨å¹´å›æµ‹")
    print("      - ä½¿ç”¨2023å¹´æŠ¥è¯„ä¼°è‚¡ç¥¨è´¨é‡")
    print("      - åœ¨2024å¹´å…¨å¹´æŒæœ‰å¹¶äº¤æ˜“")
    print("      - è§‚å¯Ÿè´¢åŠ¡å› å­åœ¨2024å¹´çš„è¡¨ç°")
    print("")
    print("   âœ… æ–¹æ¡ˆB: å­£åº¦æ»šåŠ¨å›æµ‹")
    print("      - Q1: ç”¨2023Q3æ•°æ®ï¼Œå›æµ‹2024Q1")
    print("      - Q2: ç”¨2023Q4æ•°æ®ï¼Œå›æµ‹2024Q2")
    print("      - Q3: ç”¨2024Q1æ•°æ®ï¼Œå›æµ‹2024Q3")
    print("      - Q4: ç”¨2024Q2æ•°æ®ï¼Œå›æµ‹2024Q4")
    print("")
    print("   âœ… æ–¹æ¡ˆC: 2023-2024ä¸¤å¹´éªŒè¯")
    print("      - ç”¨2023å„å­£åº¦è´¢åŠ¡æ•°æ®")
    print("      - å›æµ‹å¯¹åº”å­£åº¦çš„è‚¡ç¥¨è¡¨ç°")
    print("      - éªŒè¯å› å­çš„é¢„æµ‹èƒ½åŠ›")

    print("\n3ï¸âƒ£ å…·ä½“æ“ä½œæµç¨‹:")
    print("   æ­¥éª¤1: è®¡ç®—è´¢åŠ¡å› å­")
    print("         - ä»2023å¹´æŠ¥è®¡ç®—ROEã€è¥æ”¶å¢é•¿ç­‰")
    print("")
    print("   æ­¥éª¤2: é€‰è‚¡")
    print("         - é€‰å‡ºROE>15%ä¸”è¥æ”¶å¢é•¿>10%çš„è‚¡ç¥¨")
    print("")
    print("   æ­¥éª¤3: å›æµ‹")
    print("         - åœ¨2024å¹´æŒæœ‰è¿™äº›è‚¡ç¥¨")
    print("         - å¯¹æ¯”åŸºå‡†ï¼ˆå¦‚æ²ªæ·±300ï¼‰çš„æ”¶ç›Š")
    print("")
    print("   æ­¥éª¤4: è¯„ä¼°")
    print("         - è®¡ç®—è¶…é¢æ”¶ç›Šã€å¤æ™®æ¯”ç‡ç­‰")

    print("\n4ï¸âƒ£ ä¸ºä»€ä¹ˆ8ä¸ªå­£åº¦è¶³å¤Ÿï¼Ÿ")
    print("   âœ… è´¢åŠ¡å› å­æ˜¯ä½é¢‘å› å­ï¼Œå­£åº¦æ›´æ–°")
    print("   âœ… 8ä¸ªå­£åº¦ = 2å¹´æ•°æ®ï¼Œå¯ä»¥:")
    print("      - è®¡ç®—å› å­çš„ç¨³å®šæ€§")
    print("      - éªŒè¯å› å­çš„é¢„æµ‹èƒ½åŠ›")
    print("      - è¿›è¡Œ2024å¹´å…¨å¹´å›æµ‹")
    print("")
    print("   âš ï¸ å¦‚æœéœ€è¦10å¹´å†å²å›æµ‹:")
    print("      - éœ€è¦ä¸‹è½½2014-2024å…±40ä¸ªå­£åº¦çš„æ•°æ®")
    print("      - ä½†å¯¹äºç­–ç•¥éªŒè¯ï¼Œ2å¹´å·²è¶³å¤Ÿ")

def demo_backtest_workflow():
    """æ¼”ç¤ºå›æµ‹å·¥ä½œæµç¨‹"""

    print("\n" + "="*80)
    print("ğŸ¯ è´¢åŠ¡å› å­å›æµ‹æ¼”ç¤º")
    print("="*80)

    # è¯»å–è´¢åŠ¡æ•°æ®
    data_file = Path.home() / ".qlib/qlib_data/cn_data/financial_data/a_share_financial_latest.csv"
    df = pd.read_csv(data_file)

    print(f"\nğŸ“Š åŠ è½½è´¢åŠ¡æ•°æ®: {len(df):,} æ¡")

    # æ­¥éª¤1: ä½¿ç”¨2023å¹´æŠ¥æ•°æ®è®¡ç®—å› å­
    print("\næ­¥éª¤1: è®¡ç®—2023å¹´æŠ¥è´¢åŠ¡å› å­...")
    df_2023 = df[df['end_date'] == '20231231'].copy()

    # è®¡ç®—ç»¼åˆå¾—åˆ†
    df_2023['roe_score'] = df_2023['roe'].rank(pct=True)
    df_2023['growth_score'] = df_2023['or_yoy'].rank(pct=True)
    df_2023['value_score'] = (1/df_2023['pe']).rank(pct=True)

    df_2023['total_score'] = (
        0.4 * df_2023['roe_score'] +
        0.3 * df_2023['growth_score'] +
        0.3 * df_2023['value_score']
    )

    # è¿‡æ»¤æ‰æ— æ•ˆæ•°æ®
    valid_stocks = df_2023[
        (df_2023['roe'].notna()) &
        (df_2023['or_yoy'].notna()) &
        (df_2023['pe'].notna()) &
        (df_2023['pe'] > 0)  # PEå¿…é¡»ä¸ºæ­£
    ].copy()

    print(f"   æœ‰æ•ˆè‚¡ç¥¨: {len(valid_stocks)} åª")

    # æ­¥éª¤2: é€‰è‚¡ (Top 50)
    print("\næ­¥éª¤2: é€‰å‡ºTop 50è‚¡ç¥¨...")
    top_50 = valid_stocks.nlargest(50, 'total_score')

    print("   Top 10è‚¡ç¥¨:")
    print(top_50[['ts_code', 'roe', 'or_yoy', 'pe', 'total_score']].head(10).to_string(index=False))

    # æ­¥éª¤3: æ¨¡æ‹Ÿå›æµ‹2024å¹´
    print("\næ­¥éª¤3: æ¨¡æ‹Ÿ2024å¹´å›æµ‹...")
    print("   âš ï¸ æ³¨æ„: è¿™é‡Œéœ€è¦é…åˆä»·æ ¼æ•°æ®")
    print("   å®é™…å›æµ‹åº”è¯¥ä½¿ç”¨Qlibçš„å›æµ‹æ¡†æ¶")

    # è®¡ç®—é€‰è‚¡æ± ç‰¹å¾
    print("\n   é€‰è‚¡æ± ç‰¹å¾:")
    print(f"   â€¢ å¹³å‡ROE: {top_50['roe'].mean():.2f}%")
    print(f"   â€¢ å¹³å‡è¥æ”¶å¢é•¿: {top_50['or_yoy'].mean():.2f}%")
    print(f"   â€¢ å¹³å‡PE: {top_50['pe'].mean():.2f}")

    # å¯¹æ¯”å…¨å¸‚åœº
    print("\n   vs å…¨å¸‚åœºå¹³å‡:")
    print(f"   â€¢ å¹³å‡ROE: {valid_stocks['roe'].mean():.2f}%")
    print(f"   â€¢ å¹³å‡è¥æ”¶å¢é•¿: {valid_stocks['or_yoy'].mean():.2f}%")
    print(f"   â€¢ å¹³å‡PE: {valid_stocks['pe'].mean():.2f}")

    # è¶…é¢ç‰¹å¾
    excess_return = top_50['roe'].mean() - valid_stocks['roe'].mean()
    print(f"\n   è¶…é¢ROE: {excess_return:.2f}%")

def show_download_options():
    """å±•ç¤ºæ›´é•¿æœŸæ•°æ®ä¸‹è½½é€‰é¡¹"""

    print("\n" + "="*80)
    print("ğŸ“¥ å¦‚éœ€æ›´é•¿æœŸå†å²æ•°æ®")
    print("="*80)

    print("\né€‰é¡¹1: ä¸‹è½½è¿‘5å¹´è´¢åŠ¡æ•°æ®")
    print("   ä¼˜ç‚¹: è¶³å¤Ÿè¿›è¡Œé•¿æœŸå›æµ‹éªŒè¯")
    print("   ç¼ºç‚¹: ä¸‹è½½æ—¶é—´è¾ƒé•¿ï¼ˆçº¦1å°æ—¶ï¼‰")
    print("   å‘½ä»¤:")
    print("   # ä¿®æ”¹è„šæœ¬ä¸­çš„ START_DATE")
    print("   START_DATE = '20190101'  # ä»2019å¹´å¼€å§‹")

    print("\né€‰é¡¹2: ä¸‹è½½è¿‘10å¹´è´¢åŠ¡æ•°æ®")
    print("   ä¼˜ç‚¹: å®Œæ•´çš„å†å²å›æµ‹æ•°æ®")
    print("   ç¼ºç‚¹: ä¸‹è½½æ—¶é—´å¾ˆé•¿ï¼ˆçº¦2å°æ—¶ï¼‰")
    print("   å‘½ä»¤:")
    print("   START_DATE = '20140101'  # ä»2014å¹´å¼€å§‹")

    print("\né€‰é¡¹3: åˆ†æœŸä¸‹è½½")
    print("   ä¼˜ç‚¹: å¯ä»¥ç®¡ç†ä¸‹è½½æ—¶é—´")
    print("   æ–¹æ³•:")
    print("   # ç¬¬ä¸€æ‰¹: 2014-2018")
    print("   START_DATE = '20140101'")
    print("   END_DATE = '20181231'")
    print("   ")
    print("   # ç¬¬äºŒæ‰¹: 2019-2022")
    print("   START_DATE = '20190101'")
    print("   END_DATE = '20221231'")
    print("   ")
    print("   # ç¬¬ä¸‰æ‰¹: 2023-2024 (å·²ä¸‹è½½)")

    print("\nğŸ’¡ å»ºè®®:")
    print("   1. å…ˆç”¨ç°æœ‰æ•°æ®ï¼ˆ2023-2024ï¼‰éªŒè¯ç­–ç•¥")
    print("   2. ç¡®è®¤ç­–ç•¥æœ‰æ•ˆåï¼Œå†ä¸‹è½½æ›´é•¿æœŸæ•°æ®")
    print("   3. ä½¿ç”¨æ›´é•¿æœŸæ•°æ®è¿›è¡Œå®Œæ•´å›æµ‹")

def main():
    """ä¸»å‡½æ•°"""

    # è§£é‡Šå›æµ‹åŸç†
    explain_financial_data_backtest()

    # æ¼”ç¤ºå›æµ‹æµç¨‹
    demo_backtest_workflow()

    # å±•ç¤ºä¸‹è½½é€‰é¡¹
    show_download_options()

    print("\n" + "="*80)
    print("âœ… è´¢åŠ¡æ•°æ®å›æµ‹è¯´æ˜å®Œæˆ")
    print("="*80)

    print("\nğŸ’¡ å…³é”®è¦ç‚¹:")
    print("   1. ç°æœ‰8ä¸ªå­£åº¦æ•°æ®è¶³å¤Ÿè¿›è¡Œ2024å¹´å›æµ‹")
    print("   2. è´¢åŠ¡å› å­æ˜¯ä½é¢‘å› å­ï¼Œå­£åº¦æ›´æ–°å³å¯")
    print("   3. å»ºè®®å…ˆç”¨ç°æœ‰æ•°æ®éªŒè¯ï¼Œå†ä¸‹è½½æ›´é•¿æœŸæ•°æ®")
    print("   4. Qlibå¯ä»¥æ— ç¼é›†æˆè´¢åŠ¡æ•°æ®å’Œä»·æ ¼æ•°æ®")

if __name__ == "__main__":
    main()
