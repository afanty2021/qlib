[æ ¹ç›®å½•](../../../CLAUDE.md) > [qlib](../../CLAUDE.md) > [contrib](../CLAUDE.md) > **online**

# åœ¨çº¿æœåŠ¡æ¨¡å—

> Qlib çš„åœ¨çº¿æœåŠ¡å’Œå®æ—¶é¢„æµ‹ç³»ç»Ÿï¼Œæ”¯æŒç”Ÿäº§ç¯å¢ƒä¸‹çš„æ¨¡å‹éƒ¨ç½²å’Œå®æ—¶æ¨ç†ã€‚

## æ¨¡å—èŒè´£

åœ¨çº¿æœåŠ¡æ¨¡å—ä¸“æ³¨äºé‡åŒ–ç­–ç•¥çš„åœ¨çº¿åŒ–éƒ¨ç½²ï¼š
- å®æ—¶æ¨¡å‹æ¨ç†å’Œé¢„æµ‹æœåŠ¡
- åœ¨çº¿ç”¨æˆ·å’Œç­–ç•¥ç®¡ç†
- å®æ—¶æ•°æ®å¤„ç†å’Œæ›´æ–°
- ç”Ÿäº§ç¯å¢ƒç›‘æ§å’Œç»´æŠ¤

## æ¨¡å—ç»“æ„

```mermaid
graph TD
    A["online åœ¨çº¿æœåŠ¡"] --> B["manager.py åœ¨çº¿ç®¡ç†å™¨"];
    A --> C["online_model.py åœ¨çº¿æ¨¡å‹"];
    A --> D["operator.py åœ¨çº¿æ“ä½œç¬¦"];
    A --> E["user.py ç”¨æˆ·ç®¡ç†"];
    A --> F["utils.py å·¥å…·å‡½æ•°"];

    B --> B1["UserManager - ç”¨æˆ·ç®¡ç†"];
    B --> B2["æ•°æ®æŒä¹…åŒ–"];
    B --> B3["é…ç½®ç®¡ç†"];

    C --> C1["ScoreFileModel - è¯„åˆ†æ–‡ä»¶æ¨¡å‹"];
    C --> C2["å®æ—¶é¢„æµ‹æ¥å£"];
    C --> C3["æ¨¡å‹ç‰ˆæœ¬ç®¡ç†"];

    D --> D1["åœ¨çº¿æ•°æ®å¤„ç†"];
    D --> D2["å®æ—¶ç‰¹å¾è®¡ç®—"];
    D --> D3["ç»“æœç¼“å­˜"];

    E --> E1["ç”¨æˆ·æ•°æ®ç»“æ„"];
    E --> E2["ç­–ç•¥é…ç½®"];
    E --> E3["è´¦æˆ·ç®¡ç†"];

    click B "#manager_py" "æŸ¥çœ‹åœ¨çº¿ç®¡ç†å™¨"
    click C "#online_model_py" "æŸ¥çœ‹åœ¨çº¿æ¨¡å‹"
```

## æ ¸å¿ƒåŠŸèƒ½ç»„ä»¶

### åœ¨çº¿ç®¡ç†å™¨ (manager.py)

#### UserManager ç±»
è´Ÿè´£ç®¡ç†åœ¨çº¿ç³»ç»Ÿçš„æ‰€æœ‰ç”¨æˆ·å’Œç›¸å…³æ•°æ®ï¼š

```python
class UserManager:
    def __init__(self, user_data_path, save_report=True):
        """
        åœ¨çº¿ç³»ç»Ÿç”¨æˆ·ç®¡ç†å™¨

        å‚æ•°:
            user_data_path: ç”¨æˆ·æ•°æ®å­˜å‚¨è·¯å¾„
            save_report: æ˜¯å¦ä¿å­˜äº¤æ˜“æŠ¥å‘Š
        """
```

#### æ ¸å¿ƒåŠŸèƒ½
- **ç”¨æˆ·æ•°æ®ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç”¨æˆ·çš„æ•°æ®å’Œé…ç½®
- **ç­–ç•¥çŠ¶æ€è·Ÿè¸ª**ï¼šè®°å½•ç”¨æˆ·ç­–ç•¥çš„è¿è¡ŒçŠ¶æ€
- **æ•°æ®æŒä¹…åŒ–**ï¼šè‡ªåŠ¨ä¿å­˜ç”¨æˆ·æ•°æ®å’Œäº¤æ˜“ç»“æœ
- **ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸ**ï¼šæ”¯æŒç”¨æˆ·çš„æ·»åŠ ã€åˆ é™¤ã€æ›´æ–°æ“ä½œ

#### ä¸»è¦æ–¹æ³•
```python
# åŠ è½½æ‰€æœ‰ç”¨æˆ·
def load_users(self):
    """åŠ è½½æ‰€æœ‰ç”¨æˆ·æ•°æ®åˆ°ç®¡ç†å™¨"""

# åŠ è½½å•ä¸ªç”¨æˆ·
def load_user(self, user_id):
    """åŠ è½½æŒ‡å®šç”¨æˆ·çš„å®Œæ•´æ•°æ®"""

# æ·»åŠ æ–°ç”¨æˆ·
def add_user(self, user_id, config_file, add_date):
    """æ·»åŠ æ–°ç”¨æˆ·åˆ°ç³»ç»Ÿ"""

# ä¿å­˜ç”¨æˆ·æ•°æ®
def save_user_data(self, user_id):
    """ä¿å­˜æŒ‡å®šç”¨æˆ·çš„æ•°æ®"""

# åˆ é™¤ç”¨æˆ·
def remove_user(self, user_id):
    """ä»ç³»ç»Ÿä¸­åˆ é™¤ç”¨æˆ·"""
```

#### æ•°æ®å­˜å‚¨ç»“æ„
```
user_data_path/
â”œâ”€â”€ users.csv                 # ç”¨æˆ·ç´¢å¼•æ–‡ä»¶
â”œâ”€â”€ user_001/                 # ç”¨æˆ·æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ account/              # è´¦æˆ·æ•°æ®
â”‚   â”œâ”€â”€ strategy_user_001.pickle  # ç­–ç•¥é…ç½®
â”‚   â””â”€â”€ model_user_001.pickle     # æ¨¡å‹æ–‡ä»¶
â”œâ”€â”€ user_002/
â”‚   â””â”€â”€ ...
```

### åœ¨çº¿æ¨¡å‹ (online_model.py)

#### ScoreFileModel ç±»
åŸºäºè¯„åˆ†æ–‡ä»¶çš„ç®€å•åœ¨çº¿é¢„æµ‹æ¨¡å‹ï¼š

```python
class ScoreFileModel(Model):
    """
    è¯„åˆ†æ–‡ä»¶æ¨¡å‹ï¼Œä»é¢„è®¡ç®—çš„è¯„åˆ†æ–‡ä»¶ä¸­åŠ è½½é¢„æµ‹ç»“æœ
    """

    def __init__(self, score_path):
        """
        åˆå§‹åŒ–æ¨¡å‹

        å‚æ•°:
            score_path: è¯„åˆ†æ–‡ä»¶è·¯å¾„
        """
        pred_test = pd.read_csv(score_path, index_col=[0, 1], parse_dates=True)
        self.pred = pred_test
```

#### æ ¸å¿ƒç‰¹æ€§
- **æ–‡ä»¶é©±åŠ¨**ï¼šç›´æ¥ä»é¢„è®¡ç®—æ–‡ä»¶åŠ è½½é¢„æµ‹ç»“æœ
- **é«˜æ•ˆæŸ¥è¯¢**ï¼šåŸºäºç´¢å¼•çš„å¿«é€Ÿæ•°æ®æ£€ç´¢
- **æ—¥æœŸå®šä½**ï¼šæ”¯æŒæŒ‰æ—¥æœŸå¿«é€Ÿå®šä½é¢„æµ‹æ•°æ®
- **è½»é‡çº§è®¾è®¡**ï¼šé€‚åˆç®€å•é¢„æµ‹åœºæ™¯

#### ä¸»è¦æ¥å£
```python
def get_data_with_date(self, date, **kwargs):
    """
    è·å–æŒ‡å®šæ—¥æœŸçš„é¢„æµ‹è¯„åˆ†

    å‚æ•°:
        date: æŸ¥è¯¢æ—¥æœŸ

    è¿”å›:
        pd.Series: è‚¡ç¥¨è¯„åˆ†åºåˆ—
    """

def predict(self, x_test, **kwargs):
    """é¢„æµ‹æ¥å£ï¼ˆå ä½å®ç°ï¼‰"""

def score(self, x_test, **kwargs):
    """è¯„åˆ†æ¥å£ï¼ˆå ä½å®ç°ï¼‰"""

def fit(self, x_train, y_train, x_valid, y_valid, w_train=None, w_valid=None, **kwargs):
    """è®­ç»ƒæ¥å£ï¼ˆå ä½å®ç°ï¼‰"""
```

### ç”¨æˆ·ç®¡ç† (user.py)

#### User ç±»
è¡¨ç¤ºåœ¨çº¿ç³»ç»Ÿä¸­çš„å•ä¸ªç”¨æˆ·ï¼š

```python
class User:
    """
    ç”¨æˆ·ç±»ï¼ŒåŒ…å«è´¦æˆ·ã€ç­–ç•¥ã€æ¨¡å‹ç­‰å®Œæ•´ä¿¡æ¯
    """

    def __init__(self, account, strategy, model):
        """
        åˆå§‹åŒ–ç”¨æˆ·

        å‚æ•°:
            account: äº¤æ˜“è´¦æˆ·
            strategy: äº¤æ˜“ç­–ç•¥
            model: é¢„æµ‹æ¨¡å‹
        """
```

#### ç”¨æˆ·æ•°æ®ç»„æˆ
- **è´¦æˆ·ä¿¡æ¯**ï¼šèµ„é‡‘ã€æŒä»“ã€äº¤æ˜“è®°å½•
- **ç­–ç•¥é…ç½®**ï¼šç­–ç•¥å‚æ•°ã€äº¤æ˜“è§„åˆ™
- **æ¨¡å‹å®ä¾‹**ï¼šé¢„æµ‹æ¨¡å‹å’Œè¯„åˆ†æ•°æ®
- **å†å²è®°å½•**ï¼šäº¤æ˜“å†å²å’Œç»©æ•ˆæ•°æ®

### å·¥å…·å‡½æ•° (utils.py)

#### æ•°æ®åºåˆ—åŒ–
```python
def load_instance(file_path):
    """åŠ è½½åºåˆ—åŒ–çš„å®ä¾‹"""

def save_instance(instance, file_path):
    """ä¿å­˜å®ä¾‹åˆ°æ–‡ä»¶"""
```

#### é…ç½®ç®¡ç†
- **YAMLé…ç½®**ï¼šæ”¯æŒYAMLæ ¼å¼çš„é…ç½®æ–‡ä»¶
- **åŠ¨æ€åŠ è½½**ï¼šè¿è¡Œæ—¶åŠ¨æ€åŠ è½½ç­–ç•¥å’Œæ¨¡å‹
- **å‚æ•°éªŒè¯**ï¼šé…ç½®å‚æ•°çš„æœ‰æ•ˆæ€§æ£€æŸ¥

## åœ¨çº¿æœåŠ¡æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾
```mermaid
graph TD
    A["å®¢æˆ·ç«¯è¯·æ±‚"] --> B["APIç½‘å…³"];
    B --> C["åœ¨çº¿ç®¡ç†å™¨"];
    C --> D["ç”¨æˆ·ç®¡ç†"];
    C --> E["æ¨¡å‹æœåŠ¡"];
    C --> F["æ•°æ®æœåŠ¡"];

    D --> D1["ç”¨æˆ·æ•°æ®"];
    D --> D2["ç­–ç•¥é…ç½®"];
    D --> D3["è´¦æˆ·ä¿¡æ¯"];

    E --> E1["é¢„æµ‹æ¨¡å‹"];
    E --> E2["æ¨¡å‹ç‰ˆæœ¬"];
    E --> E3["ç¼“å­˜å±‚"];

    F --> F1["å®æ—¶æ•°æ®"];
    F --> F2["ç‰¹å¾è®¡ç®—"];
    F --> F3["ç»“æœå­˜å‚¨"];
```

### æ•°æ®æµå¤„ç†
1. **è¯·æ±‚æ¥æ”¶**ï¼šAPIç½‘å…³æ¥æ”¶ç”¨æˆ·è¯·æ±‚
2. **ç”¨æˆ·éªŒè¯**ï¼šéªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™
3. **æ•°æ®å‡†å¤‡**ï¼šåŠ è½½ç”¨æˆ·é…ç½®å’Œæ¨¡å‹
4. **é¢„æµ‹æ‰§è¡Œ**ï¼šæ‰§è¡Œå®æ—¶é¢„æµ‹å’Œå†³ç­–
5. **ç»“æœè¿”å›**ï¼šè¿”å›é¢„æµ‹ç»“æœå’Œå»ºè®®
6. **æ•°æ®æŒä¹…åŒ–**ï¼šä¿å­˜äº¤æ˜“ç»“æœå’ŒçŠ¶æ€

## éƒ¨ç½²é…ç½®

### ç¯å¢ƒè¦æ±‚
- **Python >= 3.8**ï¼šåŸºç¡€è¿è¡Œç¯å¢ƒ
- **pandas, numpy**ï¼šæ•°æ®å¤„ç†ä¾èµ–
- **redis**ï¼šç¼“å­˜å’Œä¼šè¯ç®¡ç†ï¼ˆå¯é€‰ï¼‰
- **fastapi/flask**ï¼šWebæœåŠ¡æ¡†æ¶

### é…ç½®ç¤ºä¾‹
```yaml
# config.yaml
server:
  host: "0.0.0.0"
  port: 8000
  workers: 4

database:
  type: "redis"
  host: "localhost"
  port: 6379
  db: 0

storage:
  user_data_path: "./user_data"
  model_cache_path: "./model_cache"
  backup_path: "./backup"

logging:
  level: "INFO"
  file: "./logs/online_service.log"
```

### Docker éƒ¨ç½²
```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
EXPOSE 8000

CMD ["python", "main.py"]
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æˆ·ç®¡ç†
```python
from qlib.contrib.online.manager import UserManager

# åˆå§‹åŒ–ç”¨æˆ·ç®¡ç†å™¨
manager = UserManager(user_data_path="./user_data")

# åŠ è½½æ‰€æœ‰ç”¨æˆ·
manager.load_users()

# æ·»åŠ æ–°ç”¨æˆ·
manager.add_user(
    user_id="user_001",
    config_file="config.yaml",
    add_date="2025-01-01"
)

# è·å–ç”¨æˆ·å®ä¾‹
user = manager.load_user("user_001")
```

### åœ¨çº¿é¢„æµ‹æœåŠ¡
```python
from qlib.contrib.online.online_model import ScoreFileModel

# åˆå§‹åŒ–åœ¨çº¿æ¨¡å‹
model = ScoreFileModel(score_path="predictions.csv")

# è·å–ä»Šæ—¥é¢„æµ‹
today = pd.Timestamp("2025-01-01")
predictions = model.get_data_with_date(today)

# è¿”å›Top-Kæ¨è
top_stocks = predictions.nlargest(50)
```

### ç”¨æˆ·ç­–ç•¥é…ç½®
```yaml
# user_config.yaml
user_id: "user_001"
init_cash: 1000000

model:
  class: "ScoreFileModel"
  module_path: "qlib.contrib.online.online_model"
  kwargs:
    score_path: "./models/user_001_predictions.csv"

strategy:
  class: "TopkDropoutStrategy"
  module_path: "qlib.contrib.strategy.signal_strategy"
  kwargs:
    topk: 50
    n_drop: 5
```

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
- **é¢„æµ‹ç»“æœç¼“å­˜**ï¼šç¼“å­˜å¸¸ç”¨é¢„æµ‹ç»“æœ
- **æ¨¡å‹ç¼“å­˜**ï¼šç¼“å­˜åŠ è½½çš„æ¨¡å‹å®ä¾‹
- **ç”¨æˆ·æ•°æ®ç¼“å­˜**ï¼šç¼“å­˜é¢‘ç¹è®¿é—®çš„ç”¨æˆ·æ•°æ®

### å¹¶å‘å¤„ç†
- **å¼‚æ­¥IO**ï¼šä½¿ç”¨å¼‚æ­¥å¤„ç†æå‡å¹¶å‘èƒ½åŠ›
- **è¿æ¥æ± **ï¼šæ•°æ®åº“è¿æ¥æ± ç®¡ç†
- **è´Ÿè½½å‡è¡¡**ï¼šå¤šå®ä¾‹è´Ÿè½½åˆ†å¸ƒ

### èµ„æºç®¡ç†
- **å†…å­˜ä¼˜åŒ–**ï¼šåŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„å¯¹è±¡
- **ç£ç›˜ç®¡ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- **CPUä¼˜åŒ–**ï¼šå‘é‡åŒ–è®¡ç®—å’Œå¹¶è¡Œå¤„ç†

## ç›‘æ§å’Œç»´æŠ¤

### æ€§èƒ½ç›‘æ§
```python
# æ€§èƒ½æŒ‡æ ‡æ”¶é›†
metrics = {
    "request_count": 0,
    "response_time": [],
    "error_rate": 0.0,
    "memory_usage": 0,
    "cpu_usage": 0
}
```

### å¥åº·æ£€æŸ¥
- **æœåŠ¡çŠ¶æ€**ï¼šå®šæœŸæ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
- **æ•°æ®å®Œæ•´æ€§**ï¼šéªŒè¯ç”¨æˆ·æ•°æ®å®Œæ•´æ€§
- **æ¨¡å‹å‡†ç¡®æ€§**ï¼šç›‘æ§æ¨¡å‹é¢„æµ‹æ€§èƒ½

### æ—¥å¿—ç®¡ç†
```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('online_service.log'),
        logging.StreamHandler()
    ]
)
```

## å®‰å…¨è€ƒè™‘

### æ•°æ®å®‰å…¨
- **è®¿é—®æ§åˆ¶**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸæ•°æ®å¤‡ä»½å’Œæ¢å¤

### ç½‘ç»œå®‰å…¨
- **HTTPS**ï¼šå¯ç”¨SSL/TLSåŠ å¯†
- **APIè®¤è¯**ï¼šJWTä»¤ç‰Œè®¤è¯
- **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢APIæ»¥ç”¨

## æ‰©å±•å¼€å‘

### è‡ªå®šä¹‰æ¨¡å‹æ¥å£
```python
from qlib.contrib.model.base import Model

class CustomOnlineModel(Model):
    """è‡ªå®šä¹‰åœ¨çº¿é¢„æµ‹æ¨¡å‹"""

    def predict(self, x_test, **kwargs):
        # å®ç°è‡ªå®šä¹‰é¢„æµ‹é€»è¾‘
        return predictions

    def get_data_with_date(self, date, **kwargs):
        # å®ç°æŒ‰æ—¥æœŸæŸ¥è¯¢é€»è¾‘
        return result
```

### æ–°å¢åŠŸèƒ½æ¨¡å—
```python
# æ‰©å±•ç®¡ç†å™¨åŠŸèƒ½
class EnhancedUserManager(UserManager):
    """å¢å¼ºç‰ˆç”¨æˆ·ç®¡ç†å™¨"""

    def batch_add_users(self, user_configs):
        """æ‰¹é‡æ·»åŠ ç”¨æˆ·"""
        pass

    def export_user_data(self, user_id, format="csv"):
        """å¯¼å‡ºç”¨æˆ·æ•°æ®"""
        pass
```

## å¸¸è§é—®é¢˜ (FAQ)

### Q1: å¦‚ä½•å¤„ç†æ¨¡å‹æ›´æ–°ï¼Ÿ
æ”¯æŒçƒ­æ›´æ–°æ¨¡å‹ç‰ˆæœ¬ï¼Œæ— éœ€é‡å¯æœåŠ¡ã€‚

### Q2: å¦‚ä½•å¤„ç†ç”¨æˆ·æ•°æ®å¤‡ä»½ï¼Ÿ
ç³»ç»Ÿæ”¯æŒè‡ªåŠ¨å¤‡ä»½å’Œæ‰‹åŠ¨å¤‡ä»½ä¸¤ç§æ–¹å¼ã€‚

### Q3: å¦‚ä½•å¤„ç†é«˜å¹¶å‘è®¿é—®ï¼Ÿ
ä½¿ç”¨ç¼“å­˜å’Œè¿æ¥æ± ä¼˜åŒ–ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•ã€‚

## ç›¸å…³æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- `manager.py` - åœ¨çº¿ç®¡ç†å™¨
- `online_model.py` - åœ¨çº¿é¢„æµ‹æ¨¡å‹
- `user.py` - ç”¨æˆ·ç®¡ç†
- `operator.py` - åœ¨çº¿æ“ä½œç¬¦
- `utils.py` - å·¥å…·å‡½æ•°

### é…ç½®æ–‡ä»¶
- `config.yaml` - ç³»ç»Ÿé…ç½®
- `docker-compose.yml` - å®¹å™¨ç¼–æ’
- `requirements.txt` - ä¾èµ–ç®¡ç†

## å˜æ›´è®°å½• (Changelog)

### 2025-11-17 12:53:01 - ç¬¬å››æ¬¡å¢é‡æ›´æ–°
- âœ¨ **æ–°å¢åœ¨çº¿æœåŠ¡æ¨¡å—è¯¦ç»†æ–‡æ¡£**ï¼š
  - å®Œæ•´çš„åœ¨çº¿æœåŠ¡æ¶æ„è¯´æ˜
  - ç”¨æˆ·ç®¡ç†å’Œæ¨¡å‹éƒ¨ç½²è¯¦è§£
  - å®æ—¶é¢„æµ‹å’Œæ•°æ®å¤„ç†æŒ‡å—
- ğŸ“Š **æ·±åº¦åˆ†ææ ¸å¿ƒç»„ä»¶**ï¼š
  - UserManager ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
  - ScoreFileModel åœ¨çº¿é¢„æµ‹æ¨¡å‹
  - æ•°æ®æŒä¹…åŒ–å’Œé…ç½®ç®¡ç†
- ğŸ”— **å®Œå–„éƒ¨ç½²è¿ç»´æŒ‡å—**ï¼š
  - Docker å®¹å™¨åŒ–éƒ¨ç½²
  - æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§ç»´æŠ¤
  - å®‰å…¨è€ƒè™‘å’Œæ‰©å±•å¼€å‘