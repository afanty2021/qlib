
# 执行器接口规范

<cite>
**本文档引用的文件**  
- [executor.py](file://qlib/backtest/executor.py)
- [decision.py](file://qlib/backtest/decision.py)
- [exchange.py](file://qlib/backtest/exchange.py)
- [account.py](file://qlib/backtest/account.py)
- [position.py](file://qlib/backtest/position.py)
- [report.py](file://qlib/backtest/report.py)
</cite>

## 目录
1. [引言](#引言)
2. [执行器抽象基类设计](#执行器抽象基类设计)
3. [execute方法详解](#execute方法详解)
4. [生命周期回调机制](#生命周期回调机制)
5. [类型注解与异常规范](#类型注解与异常规范)
6. [线程安全要求](#线程安全要求)
7. [继承BaseExecutor示例](#继承baseexecutor示例)
8. [扩展点边界定义](#扩展点边界定义)

## 引言
Qlib执行器（Executor）是量化回测系统中的核心组件，负责将策略生成的交易决策转化为实际的成交报告。本规范详细说明了执行器抽象基类的设计理念、接口契约以及扩展机制，为开发者提供清晰的继承和定制指导。

## 执行器抽象基类设计
`BaseExecutor`类作为所有执行器的抽象基类，定义了统一的接口契约和基础功能。该类通过依赖注入方式获取必要的基础设施，并提供了灵活的配置选项。

### 核心属性
- **time_per_step**: 交易时间步长，用于生成交易日历
- **indicator_config**: 指标计算配置，包含价格优势(pa)、正收益率(pos)、履约率(ffr)等指标的计算参数
- **generate_portfolio_metrics**: 是否生成投资组合指标
- **verbose**: 是否打印交易信息
- **track_data**: 是否生成交易决策数据，用于RL训练
- **common_infra**: 公共基础设施，包含交易账户和交易所实例

### 基础设施管理
执行器通过`LevelInfrastructure`管理不同层级的基础设施，包括：
- 交易日历管理器（TradeCalendarManager）
- 公共基础设施（CommonInfrastructure）
- 子层级基础设施（sub_level_infra）

**Section sources**
- [executor.py](file://qlib/backtest/executor.py#L24-L124)
- [utils.py](file://qlib/backtest/utils.py#L20-L190)

## execute方法详解
`execute`方法是执行器的核心接口，负责处理交易决策并返回执行结果。

### 输入参数结构
```python
def execute(self, trade_decision: BaseTradeDecision, level: int = 0) -> List[object]:
```

#### trade_decision参数
包含以下关键信息：
- **订单列表**: 由`Order`对象组成的列表，每个订单包含股票代码、数量、买卖方向等信息
- **市场数据快照**: 通过`trade_exchange`提供的实时市场数据
- **交易时间范围**: 决策的有效时间区间
- **交易限制**: 包括涨跌停限制、成交量限制等

#### level参数
表示当前执行器的层级，0表示顶层执行器，用于支持嵌套执行器架构。

### 返回值格式
返回一个包含成交报告的集合，每个报告包含以下信息：
- **订单对象**: 原始订单信息
- **成交价值**: 实际成交金额
- **交易成本**: