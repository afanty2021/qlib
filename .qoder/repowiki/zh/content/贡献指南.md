
# 贡献指南

<cite>
**本文档中引用的文件**
- [code_standard_and_dev_guide.rst](file://docs/developer/code_standard_and_dev_guide.rst)
- [CODE_OF_CONDUCT.md](file://CODE_OF_CONDUCT.md)
- [__init__.py](file://qlib/contrib/model/__init__.py)
- [processor.py](file://qlib/data/dataset/processor.py)
- [handler.py](file://qlib/data/dataset/handler.py)
- [highfreq_processor.py](file://qlib/contrib/data/highfreq_processor.py)
- [test_processor.py](file://tests/data_mid_layer_tests/test_processor.py)
- [conftest.py](file://tests/conftest.py)
</cite>

## 目录
1. [简介](#简介)
2. [代码标准](#代码标准)
3. [开发流程](#开发流程)
4. [模型贡献规范](#模型贡献规范)
5. [数据处理器开发](#数据处理器开发)
6. [测试要求](#测试要求)
7. [Pull Request审查流程](#pull-request审查流程)
8. [社区行为准则](#社区行为准则)
9. [环境搭建与提交路径](#环境搭建与提交路径)

## 简介
本指南旨在为开发者提供完整的贡献指导，涵盖代码标准、开发流程和模型贡献规范。通过遵循本文档中的规定，新贡献者可以快速上手并有效参与项目开发。

## 代码标准
### 文档字符串
请使用[Numpydoc风格](https://stackoverflow.com/a/24385103)编写文档字符串。

### 持续集成
持续集成（CI）工具会在每次推送新提交时运行测试，并在拉取请求的"检查"部分报告结果。

1. Qlib将使用black检查代码格式。如果代码不符合Qlib的标准（例如常见的空格和制表符混用错误），PR将报错。
   可以通过以下命令修复：
```bash
pip install black
python -m black . -l 120
```

2. Qlib将使用pylint检查代码风格。具体检查命令实现在[github action工作流](https://github.com/microsoft/qlib/blob/0e8b94a552f1c457cfa6cd2c1bb3b87ebb3fb279/.github/workflows/test.yml#L66)中。
   有时pylint的限制可能不太合理，可以通过以下方式忽略特定错误：
```python
return -ICLoss()(pred, target, index)  # pylint: disable=E1130
```

3. Qlib将使用flake8检查代码风格。具体检查命令实现在[github action工作流](https://github.com/microsoft/qlib/blob/0e8b94a552f1c457cfa6cd2c1bb3b87ebb3fb279/.github/workflows/test.yml#L73)中。
   可以通过以下命令修复：
```bash
flake8 --ignore E501,F541,E402,F401,W503,E741,E266,E203,E302,E731,E265,W291,E713,E265,W293 qlib
```

4. Qlib已集成pre-commit，这将使开发者更容易格式化代码。
   只需运行以下两个命令，当执行git commit命令时，代码将自动使用black和flake8进行格式化：
```bash
pip install -e .[dev]
pre-commit install
```

**Section sources**
- [code_standard_and_dev_guide.rst](file://docs/developer/code_standard_and_dev_guide.rst#L0-L62)

## 开发流程
作为开发者，您通常希望对Qlib进行修改，并希望这些修改能直接反映在您的环境中而无需重新安装。可以通过以下命令以可编辑模式安装Qlib：
`[dev]`选项将帮助您安装开发Qlib时相关的一些包（例如pytest, sphinx）

```bash
pip install -e ".[dev]"
```

**Section sources**
- [code_standard_and_dev_guide.rst](file://docs/developer/code_standard_and_dev_guide.rst#L63-L76)

## 模型贡献规范
### 模型注册
所有贡献的机器学习模型需要在`qlib/contrib/model/__init__.py`中注册。系统通过`all_model_classes`元组来管理所有可用模型。

```python
all_model_classes = (CatBoostModel, DEnsembleModel, LGBModel, XGBModel, LinearModel) + pytorch_classes
```

### 模型接口
新添加的模型必须实现统一的接口规范，包括：
- `fit(dataset)`：训练模型
- `predict(dataset)`：生成预测
- `save()`：保存模型
- `load()`：加载模型

### 兼容性要求
确保新模型与现有架构兼容：
1. 遵循相同的数据输入输出格式
2. 使用标准的配置结构
3. 支持Qlib的工作流系统
4. 符合性能监控要求

**Section sources**
- [__init__.py](file://qlib/contrib/model/__init__.py#L42-L42)

## 数据处理器开发
### 处理器基类
所有数据处理器都继承自`Processor`基类，该类定义了标准接口：

```python
class Processor(Serializable):
    def fit(self, df: pd.DataFrame = None):
        """
        学习数据处理参数
        参数:
            df : pd.DataFrame - 原始数据或前一个处理器的输出
        """

    @abc.abstractmethod
    def __call__(self, df: pd.DataFrame):
        """
        处理数据
        注意：处理器可能会就地修改`df`的内容！
        参数:
            df : pd.DataFrame - 处理器的原始数据或前一个处理器的结果
        """
```

### 标准处理器类型
Qlib提供了多种预定义的数据处理器：

#### 归一化处理器
- `MinMaxNorm`: 最小-最大归一化
- `ZScoreNorm`: Z-Score标准化
- `RobustZScoreNorm`: 鲁棒Z-Score标准化
- `CSZScoreNorm`: 横截面Z-Score标准化

#### 缺失值处理
- `DropnaProcessor`: 删除包含NaN的行
- `Fillna`: 填充NaN值
- `CSZFillna`: 横截面填充NaN

#### 特征工程
- `CSRankNorm`: 横截面排名归一化
- `ProcessInf`: 处理无穷大值
- `TanhProcess`: 使用tanh处理噪声数据

### 自定义处理器开发
创建新的数据处理器时，请遵循以下步骤：
1. 继承`Processor`基类
2. 实现`fit`方法用于学习处理参数
3. 实现`__call__`方法用于实际数据处理
4. 确保处理过程是可序列化的
5. 添加适当的文档字符串

**Section sources**
- [processor.py](file://qlib/data/dataset/processor.py#L0-L419)
- [handler.py](file://qlib/data/dataset/handler.py#L0-L786)

## 测试要求
### 单元测试重要性
单元测试是确保代码质量和功能正确性的关键。所有贡献的代码都必须包含相应的测试用例。

### 测试目录结构
测试代码位于`tests/`目录下，按功能模块组织：
- `tests/backtest/`: 回测相关测试
- `tests/data_mid_layer_tests/`: 数据中间层测试
- `tests/dataset_tests/`: 数据集测试
- `tests/model/`: 模型测试
- `tests/ops/`: 操作符测试

### 编写有效测试用例
#### 测试覆盖率
确保测试覆盖以下方面：
- 正常情况下的功能
- 边界条件
- 异常处理
- 性能基准

#### 测试示例
```python
def test_MinMaxNorm(self):
    origin_df = D.features([self.TEST_INST], ["$high", "$open", "$low", "$close"]).tail(10)
    origin_df["test"] = 0
    df = origin_df.copy()
    mmn = MinMaxNorm(fields_group=None, fit_start_time="2021-05-31", fit_end_time="2021-06-11")
    mmn.fit(df)
    mmn.__call__(df)
    origin_df = normalize(origin_df)
    assert (df == origin_df).all().all()
```

#### 测试最佳实践
1. 使用真实数据样本
2. 包含断言验证结果
3. 测试异常情况
4. 保持测试独立性
5. 提供清晰的测试描述

**Section sources**
- [test_processor.py](file://tests/data_mid_layer_tests/test_processor.py#L0-L75)
- [conftest.py](file://tests/conftest.py#L0-L26)

## Pull Request审查流程
### PR准备
在提交Pull Request之前，请确保：
1. 代码符合编码标准
2. 所有测试通过
3. 文档更新完整
4. 变更日志记录适当

### 审查标准
PR将根据以下标准进行审查：
- 代码质量与可读性
- 功能完整性
- 测试覆盖率
- 文档完整性
- 与现有架构的兼容性
- 性能影响

### 反馈与迭代
审查者可能会提出改进建议，贡献者应：
1. 及时响应反馈
2. 根据建议进行修改
3. 解释设计决策
4. 保持沟通礼貌

## 社区行为准则
本项目采用[Microsoft开源行为准则](https://opensource.microsoft.com/codeofconduct/)。

资源：
- [Microsoft开源行为准则](https://opensource.microsoft.com/codeofconduct/)
- [Microsoft行为准则常见问题](https://opensource.microsoft.com/codeofconduct/faq/)
- 问题或疑虑请联系[opencode@microsoft.com](mailto:opencode@microsoft.com)

**Section sources**
- [CODE_OF_CONDUCT.md](file://CODE_OF_CONDUCT.md#L0-L9)

## 环境搭建与提交路径
### 环境准备
1. 克隆仓库：
