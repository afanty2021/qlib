# 特征工程

<cite>
**本文档中引用的文件**
- [processor.py](file://qlib/data/dataset/processor.py)
- [ops.py](file://qlib/data/ops.py)
- [filter.py](file://qlib/data/filter.py)
- [inst_processor.py](file://qlib/data/inst_processor.py)
- [highfreq_processor.py](file://examples/highfreq/highfreq_processor.py)
- [highfreq_ops.py](file://examples/highfreq/highfreq_ops.py)
</cite>

## 目录
1. [引言](#引言)
2. [预处理算子实现原理](#预处理算子实现原理)
3. [表达式引擎操作符](#表达式引擎操作符)
4. [股票池筛选机制](#股票池筛选机制)
5. [实例独立处理](#实例独立处理)
6. [特征流水线构建](#特征流水线构建)
7. [高频特征构造](#高频特征构造)

## 引言
Qlib框架提供了一套完整的量化投资特征工程解决方案，通过模块化设计实现了数据预处理、特征生成和样本筛选等功能。本系统性文档聚焦于Qlib核心特征工程能力，深入分析其处理器架构、表达式引擎和筛选机制。

## 预处理算子实现原理

Qlib在`processor.py`中定义了一系列标准化的预处理算子，这些算子继承自基类`Processor`并实现了`fit`和`__call__`方法。每个处理器都遵循时间一致性约束，确保不会引入未来信息泄露。

标准化处理包括多种方法：`ZScoreNorm`使用均值和标准差进行标准化；`RobustZScoreNorm`采用中位数和绝对中位差作为稳健统计量；`CSZScoreNorm`执行横截面z-score归一化；`MinMaxNorm`则将特征缩放到[0,1]区间。去极值处理通过`RobustZScoreNorm`中的`clip_outlier`参数实现，将超出三倍标准差的异常值进行截断。

行业中性化等复杂变换可通过组合多个基础处理器实现。例如，先按行业分组计算统计量，再对行业内个股进行标准化处理。所有处理器都支持配置`fit_start_time`和`fit_end_time`参数，明确指定用于学习变换参数的时间范围，从而保证训练与推断阶段的一致性。

**Section sources**
- [processor.py](file://qlib/data/dataset/processor.py#L1-L419)

## 表达式引擎操作符

基于`ops.py`构建的表达式引擎是Qlib特征构造的核心，它提供了丰富的可复用操作符来构建复杂的特征流水线。该引擎采用延迟计算模式，只有在实际需要时才加载和计算数据。

操作符分为多个类别：元素级操作符如`Abs`、`Log`、`Sign`；成对操作符如`Add`、`Sub`、`Mul`、`Div`；条件操作符`If`；滚动窗口操作符`Rolling`及其衍生类如`Ref`（参考）、`Mean`（均值）等。特别地，`ChangeInstrument`操作符允许跨金融工具计算，例如计算个股相对于市场指数的beta值。

这些操作符可以灵活组合形成复杂的特征表达式。例如，`($close-$open)/$open`表示日收益率，`Rolling(Mean(volume), 5)`表示五日成交量均值。每个操作符都会正确维护其回溯窗口大小，确保整个表达式树的时间依赖关系得到准确跟踪。

**Section sources**
- [ops.py](file://qlib/data/ops.py#L1-L799)

## 股票池筛选机制

`filter.py`实现了动态股票池筛选功能，主要通过`ExpressionDFilter`和`NameDFilter`两个核心类完成。`ExpressionDFilter`允许用户基于任意特征表达式进行筛选，例如"$volume > 1000000"可以选择成交量大于百万的股票。

筛选过程考虑了时间维度，可以在特定时间段内应用不同的筛选规则。`SeriesDFilter`基类提供了统一的接口，通过`_getFilterSeries`方法获取过滤序列，并利用`_filterSeries`和`_toTimestamp`方法完成实际的筛选逻辑。这种设计使得筛选既可以基于静态规则（如股票名称正则匹配），也可以基于动态特征阈值。

筛选器还支持配置起止时间和保持策略，决定是否保留那些在筛选期间没有数据的股票。这为构建滚动训练集和避免生存者偏差提供了重要支持。

**Section sources**
- [filter.py](file://qlib/data/filter.py#L1-L375)

## 实例独立处理

`inst_processor.py`定义了`InstProcessor`抽象基类，专门用于对单个金融工具实例进行独立处理。与普通处理器不同，实例处理器接收额外的`instrument`参数，使其能够根据具体标的物特性进行定制化处理。

`TimeRangeFlt`是一个典型示例，它检查每个股票的数据时间范围是否满足指定条件。这种方法适用于需要逐个处理每个金融工具的场景，比如高频交易中的订单流分析或特定合约的到期日处理。

实例处理器的设计体现了关注点分离原则：常规处理器专注于跨资产的通用变换，而实例处理器则处理与特定金融工具有关的逻辑。两者协同工作，构成了完整的数据处理管道。

**Section sources**
- [inst_processor.py](file://qlib/data/inst_processor.py#L1-L22)

## 特征流水线构建

在Qlib中，可以通过组合多个`Processor`实例形成完整的特征转换流程。典型的构建方式是在数据集处理器（Handler）中按顺序注册各个处理器，它们将按照定义的顺序依次应用于原始数据。

```python
processors = [
    DropnaLabel(),
    Fillna(fill_value=0),
    RobustZScoreNorm(fit_start_time="2008-01-01", fit_end_time="2014-12-31"),
    CSRankNorm()
]
```

关键的时间一致性约束通过严格区分拟合（fit）和应用（call）阶段来保证。拟合阶段仅使用历史数据计算变换参数，而应用阶段则将这些固定参数应用于后续数据。这种方式有效防止了未来信息泄露，确保了模型评估结果的真实性。

**Section sources**
- [processor.py](file://qlib/data/dataset/processor.py#L1-L419)

## 高频特征构造

对于高频特征构造，Qlib提供了专门的扩展模块`contrib.highfreq_processor`作为最佳实践参考。`examples/highfreq/highfreq_processor.py`中的`HighFreqNorm`展示了针对分钟级数据的特殊处理方法。

高频处理器通常包含更精细的归一化策略，例如分别对价格和成交量特征采用不同的缩放方案。代码示例显示了如何先取对数变换成交量，然后使用稳健统计量进行标准化，并对极端值进行特殊处理。最后通过重塑数组结构适应强化学习执行器的需求。

`highfreq_ops.py`补充了适用于高频数据的操作符，如`DayLast`获取日内最后一个值，`FFillNan`前向填充缺失值，`Cut`操作符去除边界数据点等。这些专用组件共同构成了强大的高频特征工程工具集。

**Section sources**
- [highfreq_processor.py](file://examples/highfreq/highfreq_processor.py#L1-L76)
- [highfreq_ops.py](file://examples/highfreq/highfreq_ops.py#L1-L167)