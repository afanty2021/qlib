# Aè‚¡å…¨å¸‚åœºæ•°æ®è·å–è„šæœ¬ä½¿ç”¨è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

`fetch_all_a_stocks.py` æ˜¯ä¸€ä¸ªç”¨äºè·å–Aè‚¡å…¨å¸‚åœºå†å²æ•°æ®çš„è„šæœ¬ï¼Œæ”¯æŒï¼š

- ğŸ“ˆ **è‚¡ç¥¨æ•°æ®**ï¼šè·å–æ‰€æœ‰Aè‚¡ä¸Šå¸‚å…¬å¸çš„å†å²æ—¥çº¿æ•°æ®
- ğŸ“Š **æŒ‡æ•°æ•°æ®**ï¼šè·å–ä¸»è¦å¸‚åœºæŒ‡æ•°çš„å†å²æ—¥çº¿æ•°æ®
- ğŸš¦ **é¢‘ç‡æ§åˆ¶**ï¼šè‡ªåŠ¨æ§åˆ¶è¯·æ±‚é¢‘ç‡ï¼Œé¿å…è¶…è¿‡TuShare APIé™åˆ¶
- ğŸ’¾ **æ–­ç‚¹ç»­ä¼ **ï¼šæ”¯æŒä¸­æ–­åç»§ç»­è·å–ï¼Œä¸ä¼šé‡å¤ä¸‹è½½
- ğŸ“ˆ **è¿›åº¦ç›‘æ§**ï¼šå®æ—¶æ˜¾ç¤ºè·å–è¿›åº¦å’Œç»Ÿè®¡ä¿¡æ¯
- ğŸ’¾ **æ•°æ®ç¼“å­˜**ï¼šè‡ªåŠ¨è·³è¿‡å·²è·å–çš„æœ€æ–°æ•°æ®

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿å·²å®‰è£…å¿…è¦çš„ä¾èµ–ï¼š

```bash
pip install qlib tushare pandas numpy
```

### 2. é…ç½®TuShare Token

ä» [TuShareå®˜ç½‘](https://tushare.pro) æ³¨å†Œå¹¶è·å–API Tokenï¼Œç„¶åè®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
export TUSHARE_TOKEN="your_token_here"
```

æˆ–è€…åœ¨è¿è¡Œè„šæœ¬æ—¶é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šï¼š

```bash
python fetch_all_a_stocks.py --token your_token_here
```

### 3. è¿è¡Œè„šæœ¬

**åŸºæœ¬ç”¨æ³•**ï¼ˆè·å–ä»2000å¹´è‡³ä»Šçš„æ‰€æœ‰æ•°æ®ï¼‰ï¼š

```bash
python fetch_all_a_stocks.py
```

**æŒ‡å®šæ—¥æœŸèŒƒå›´**ï¼š

```bash
python fetch_all_a_stocks.py --start-date 20200101 --end-date 20241231
```

**è‡ªå®šä¹‰å‚æ•°**ï¼š

```bash
python fetch_all_a_stocks.py \
    --start-date 20200101 \
    --batch-size 50 \
    --rate-limit 150 \
    --data-dir /path/to/data
```

## å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--token` | TuShare API Token | ä»ç¯å¢ƒå˜é‡ `TUSHARE_TOKEN` è¯»å– |
| `--start-date` | å¼€å§‹æ—¥æœŸï¼ˆYYYYMMDDæ ¼å¼ï¼‰ | `20000101` |
| `--end-date` | ç»“æŸæ—¥æœŸï¼ˆYYYYMMDDæ ¼å¼ï¼‰ | ä»Šå¤© |
| `--batch-size` | æ¯æ‰¹è·å–çš„è‚¡ç¥¨æ•°é‡ | `100` |
| `--rate-limit` | æ¯åˆ†é’Ÿè¯·æ±‚æ•°é™åˆ¶ | `180` |
| `--data-dir` | æ•°æ®ä¿å­˜ç›®å½• | `~/.qlib/qlib_data/cn_data` |
| `--resume` | ä»æ–­ç‚¹æ¢å¤ | `False` |
| `--no-adjust` | ä¸å¤æƒï¼ˆé»˜è®¤å‰å¤æƒï¼‰ | `False` |
| `--no-skip` | ä¸è·³è¿‡å·²å­˜åœ¨çš„æ•°æ® | `False` |

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡è·å–å…¨å¸‚åœºæ•°æ®

```bash
# è·å–ä»2000å¹´è‡³ä»Šçš„æ‰€æœ‰Aè‚¡æ•°æ®
python fetch_all_a_stocks.py --start-date 20000101
```

**é¢„è®¡è€—æ—¶**ï¼šçº¦5-10å°æ—¶ï¼ˆå–å†³äºç½‘ç»œé€Ÿåº¦å’ŒAPIé™åˆ¶ï¼‰

### åœºæ™¯2ï¼šå¢é‡æ›´æ–°æ•°æ®

```bash
# åªè·å–æœ€è¿‘ä¸€å¹´çš„æ•°æ®ï¼ˆä¼šè‡ªåŠ¨è·³è¿‡å·²æœ‰çš„æ•°æ®ï¼‰
python fetch_all_a_stocks.py --start-date 20240101
```

### åœºæ™¯3ï¼šæ–­ç‚¹ç»­ä¼ 

å¦‚æœè·å–è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼ˆCtrl+Cæˆ–ç½‘ç»œé—®é¢˜ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `--resume` å‚æ•°ç»§ç»­ï¼š

```bash
python fetch_all_a_stocks.py --resume
```

### åœºæ™¯4ï¼šè·å–ç‰¹å®šæ—¶é—´æ®µæ•°æ®

```bash
# è·å–2023å¹´çš„æ•°æ®
python fetch_all_a_stocks.py --start-date 20230101 --end-date 20231231
```

### åœºæ™¯5ï¼šè·å–ä¸å¤æƒæ•°æ®

```bash
# è·å–åŸå§‹ä¸å¤æƒçš„æ•°æ®
python fetch_all_a_stocks.py --no-adjust
```

## è¾“å‡ºæ–‡ä»¶ç»“æ„

æ•°æ®å°†ä¿å­˜åœ¨æŒ‡å®šçš„æ•°æ®ç›®å½•ä¸­ï¼ˆé»˜è®¤ `~/.qlib/qlib_data/cn_data/`ï¼‰ï¼š

```
~/.qlib/qlib_data/cn_data/
â”œâ”€â”€ stock_data/              # è‚¡ç¥¨æ•°æ®
â”‚   â”œâ”€â”€ SH600000.csv         # æµ¦å‘é“¶è¡Œ
â”‚   â”œâ”€â”€ SZ000001.csv         # å¹³å®‰é“¶è¡Œ
â”‚   â””â”€â”€ ...
â”œâ”€â”€ index_data/              # æŒ‡æ•°æ•°æ®
â”‚   â”œâ”€â”€ 000001.SH.csv        # ä¸Šè¯æŒ‡æ•°
â”‚   â”œâ”€â”€ 399001.SZ.csv        # æ·±è¯æˆæŒ‡
â”‚   â””â”€â”€ ...
â””â”€â”€ fetch_stats.json         # è·å–ç»Ÿè®¡ä¿¡æ¯
```

### æ•°æ®æ–‡ä»¶æ ¼å¼

æ¯ä¸ªCSVæ–‡ä»¶åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `date` | äº¤æ˜“æ—¥æœŸ |
| `open` | å¼€ç›˜ä»· |
| `high` | æœ€é«˜ä»· |
| `low` | æœ€ä½ä»· |
| `close` | æ”¶ç›˜ä»· |
| `volume` | æˆäº¤é‡ |
| `amount` | æˆäº¤é¢ |

## è¿›åº¦ç®¡ç†

è„šæœ¬ä½¿ç”¨SQLiteæ•°æ®åº“ä¿å­˜è¿›åº¦ï¼ˆé»˜è®¤ `~/.qlib/fetch_progress.db`ï¼‰ï¼Œæ”¯æŒä»¥ä¸‹æ“ä½œï¼š

### æŸ¥çœ‹è¿›åº¦

```python
import sqlite3

conn = sqlite3.connect("~/.qlib/fetch_progress.db")
cursor = conn.execute("""
    SELECT status, COUNT(*) as count
    FROM fetch_progress
    WHERE type = 'stock' AND start_date = '20000101'
    GROUP BY status
""")
for row in cursor.fetchall():
    print(f"{row[0]}: {row[1]}")
```

### é‡ç½®å¤±è´¥çš„ä»»åŠ¡

å¦‚æœæŸäº›è‚¡ç¥¨è·å–å¤±è´¥ï¼Œå¯ä»¥é‡ç½®åé‡è¯•ï¼š

```python
import sqlite3

conn = sqlite3.connect("~/.qlib/fetch_progress.db")
conn.execute("""
    UPDATE fetch_progress
    SET status = 'pending', retry_count = 0
    WHERE status = 'failed'
""")
conn.commit()
```

ç„¶ååœ¨è¿è¡Œè„šæœ¬æ—¶ä½¿ç”¨ `--resume` å‚æ•°ã€‚

## æ€§èƒ½ä¼˜åŒ–

### é¢‘ç‡æ§åˆ¶

TuShare APIçš„é¢‘ç‡é™åˆ¶ï¼š
- **å…è´¹è´¦æˆ·**ï¼š200è¯·æ±‚/åˆ†é’Ÿ
- **é«˜çº§è´¦æˆ·**ï¼š500-1000è¯·æ±‚/åˆ†é’Ÿ

è„šæœ¬é»˜è®¤è®¾ç½®ä¸º180è¯·æ±‚/åˆ†é’Ÿï¼Œç•™æœ‰ä½™é‡é¿å…è§¦å‘é™åˆ¶ã€‚

å¦‚éœ€è°ƒæ•´ï¼Œä½¿ç”¨ `--rate-limit` å‚æ•°ï¼š

```bash
# é«˜çº§è´¦æˆ·å¯ä»¥æé«˜é¢‘ç‡é™åˆ¶
python fetch_all_a_stocks.py --rate-limit 450
```

### æ‰¹é‡å¤§å°

é»˜è®¤æ¯æ‰¹å¤„ç†100åªè‚¡ç¥¨ï¼Œå¯æ ¹æ®ç½‘ç»œçŠ¶å†µè°ƒæ•´ï¼š

```bash
# ç½‘ç»œè¾ƒå¥½æ—¶å¯ä»¥å¢å¤§æ‰¹é‡
python fetch_all_a_stocks.py --batch-size 200

# ç½‘ç»œä¸ç¨³å®šæ—¶å¯ä»¥å‡å°æ‰¹é‡
python fetch_all_a_stocks.py --batch-size 50
```

## æ•°æ®éªŒè¯

è·å–å®Œæˆåï¼Œå¯ä»¥éªŒè¯æ•°æ®çš„å®Œæ•´æ€§ï¼š

```python
import pandas as pd
from pathlib import Path

data_dir = Path.home() / ".qlib" / "qlib_data" / "cn_data"
stock_files = list((data_dir / "stock_data").glob("*.csv"))

print(f"æ€»è‚¡ç¥¨æ•°: {len(stock_files)}")

# æ£€æŸ¥æ•°æ®é‡
for file in stock_files[:5]:
    df = pd.read_csv(file)
    print(f"{file.name}: {len(df)} è¡Œæ•°æ®")
```

## ä¸Qlibé›†æˆ

è·å–çš„æ•°æ®å¯ä»¥ç›´æ¥åœ¨Qlibä¸­ä½¿ç”¨ï¼š

```python
import qlib
from qlib.data import D

# åˆå§‹åŒ–Qlibï¼ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼‰
qlib.init(provider_uri="~/.qlib/qlib_data/cn_data")

# è·å–è‚¡ç¥¨åˆ—è¡¨
instruments = D.instruments("all")

# è·å–ç‰¹å¾æ•°æ®
data = D.features(
    instruments=["SH600000", "SZ000001"],
    fields=["close", "volume"],
    start_time="2024-01-01",
    end_time="2024-12-31"
)

print(data.head())
```

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•è·å–TuShare Tokenï¼Ÿ

A: è®¿é—® [TuShareå®˜ç½‘](https://tushare.pro) æ³¨å†Œè´¦å·ï¼Œç„¶ååœ¨ä¸ªäººä¸­å¿ƒè·å–API Tokenã€‚

### Q2: æ•°æ®è·å–éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

A: å–å†³äºæ•°æ®èŒƒå›´å’Œç½‘ç»œé€Ÿåº¦ï¼š
- è·å–è¿‘1å¹´æ•°æ®ï¼šçº¦30åˆ†é’Ÿ
- è·å–è¿‘5å¹´æ•°æ®ï¼šçº¦1-2å°æ—¶
- è·å–å…¨å†å²æ•°æ®ï¼šçº¦5-10å°æ—¶

### Q3: å¦‚ä½•å¤„ç†è·å–å¤±è´¥çš„æƒ…å†µï¼Ÿ

A:
1. ä½¿ç”¨ `--resume` å‚æ•°ç»§ç»­è·å–
2. æŸ¥çœ‹ `fetch_stats.json` äº†è§£å¤±è´¥æƒ…å†µ
3. æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒTokenæƒé™
4. å¯ä»¥å•ç‹¬é‡è¯•å¤±è´¥çš„è‚¡ç¥¨

### Q4: æ•°æ®ä¼šå ç”¨å¤šå°‘ç£ç›˜ç©ºé—´ï¼Ÿ

A: å¤§çº¦ï¼š
- è¿‘1å¹´æ•°æ®ï¼šçº¦500MB
- è¿‘5å¹´æ•°æ®ï¼šçº¦2GB
- å…¨å†å²æ•°æ®ï¼šçº¦5-10GB

### Q5: å¦‚ä½•æ›´æ–°æ•°æ®åˆ°æœ€æ–°æ—¥æœŸï¼Ÿ

A: ç›´æ¥è¿è¡Œè„šæœ¬ï¼Œä¼šè‡ªåŠ¨è·³è¿‡å·²æœ‰çš„æœ€æ–°æ•°æ®ï¼š

```bash
python fetch_all_a_stocks.py --start-date 20200101
```

### Q6: è„šæœ¬æ”¯æŒå¹¶è¡Œè·å–å—ï¼Ÿ

A: ç›®å‰æ˜¯ä¸²è¡Œè·å–ä»¥é¿å…APIé™åˆ¶ã€‚åç»­ç‰ˆæœ¬å¯èƒ½ä¼šå¢åŠ å¹¶è¡Œæ”¯æŒã€‚

## æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
AStockFetcher
â”œâ”€â”€ FetchConfig        # é…ç½®ç®¡ç†
â”œâ”€â”€ FetchStats         # ç»Ÿè®¡ä¿¡æ¯
â”œâ”€â”€ ProgressManager    # è¿›åº¦ç®¡ç†ï¼ˆSQLiteï¼‰
â”œâ”€â”€ TuShareProvider    # æ•°æ®æä¾›è€…
â””â”€â”€ TuShareAPIClient   # APIå®¢æˆ·ç«¯
```

### é¢‘ç‡æ§åˆ¶

ä½¿ç”¨æ»‘åŠ¨çª—å£ç®—æ³•æ§åˆ¶è¯·æ±‚é¢‘ç‡ï¼š

```
æ—¶é—´çª—å£: 60ç§’
æœ€å¤§è¯·æ±‚: 180æ¬¡/åˆ†é’Ÿ
è¯·æ±‚é—´éš”: 0.35ç§’
```

### æ–­ç‚¹ç»­ä¼ 

ä½¿ç”¨SQLiteæ•°æ®åº“ä¿å­˜æ¯ä¸ªè‚¡ç¥¨çš„è·å–çŠ¶æ€ï¼š

- `pending`: å¾…è·å–
- `success`: æˆåŠŸ
- `failed`: å¤±è´¥
- `skipped`: è·³è¿‡ï¼ˆå·²å­˜åœ¨ï¼‰
- `no_data`: æ— æ•°æ®

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-01-XX)
- âœ… åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- ğŸ“Š æ”¯æŒè‚¡ç¥¨å’ŒæŒ‡æ•°æ•°æ®è·å–
- ğŸš¦ å†…ç½®é¢‘ç‡æ§åˆ¶
- ğŸ’¾ æ–­ç‚¹ç»­ä¼ æ”¯æŒ
- ğŸ“ˆ å®æ—¶è¿›åº¦ç›‘æ§

## è®¸å¯è¯

æœ¬è„šæœ¬éµå¾ªQlibé¡¹ç›®çš„è®¸å¯è¯åè®®ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤é—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼
